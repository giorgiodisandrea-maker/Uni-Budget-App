<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Univio â€“ Student Budgeting</title>

  <link rel="stylesheet" href="style.css">

  <!-- Firebase (compat SDK for plain HTML + GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBnn-u991pW4m3En3AlmpIPCplZ9ev4TOA",
      authDomain: "uni-budget-app.firebaseapp.com",
      projectId: "uni-budget-app",
      storageBucket: "uni-budget-app.firebasestorage.app",
      messagingSenderId: "807550470586",
      appId: "1:807550470586:web:09c16fa0fe008653917583"
    };

    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    window.functions = firebase.functions(); // required for Stripe portal link
  </script>
</head>

<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="brand">
      <img src="logo.svg" alt="Univio logo" class="logo-img">
      <span class="brand-name">Univio</span>
    </div>

    <nav class="nav">
      <button class="nav-link active" data-page="home">Home</button>
      <button class="nav-link" data-page="calculator">Calculate</button>
      <button class="nav-link" data-page="account">Account</button>
    </nav>
  </header>

  <main class="shell">
    <!-- HOME -->
    <section id="page-home" class="page active">
      <div class="card">
        <h1>Student budgeting, simplified.</h1>
        <p class="muted">
          Plan your week using income, subscriptions, university city costs, and nights out.
          Sign in to save and reload budgets.
        </p>

        <div class="home-actions">
          <button class="primary" id="go-calc">Calculate my budget</button>
          <button class="secondary" id="go-account">Sign in</button>
        </div>

        <div class="notice">
          <strong>Tip:</strong> After you calculate, hit <strong>Save</strong>. When you return and sign in, Univio can auto-load your last budget.
        </div>
      </div>
    </section>

    <!-- CALCULATOR -->
    <section id="page-calculator" class="page">
      <div class="card">
        <div class="row-between">
          <div>
            <h1>Calculate budget</h1>
            <p class="muted">Weekly estimate based on your inputs.</p>
          </div>
          <div class="pill" id="premiumPill" style="display:none;">Premium</div>
        </div>

        <div class="form">
          <label>
            <span>Student loan (per year)</span>
            <input id="loan" type="number" placeholder="e.g. 9000">
          </label>

          <label>
            <span>Monthly wage</span>
            <input id="wage" type="number" placeholder="e.g. 450">
          </label>

          <label>
            <span>Personal funds</span>
            <input id="personal" type="number" placeholder="e.g. 500">
          </label>

          <label>
            <span>Monthly subscriptions</span>
            <input id="subscriptions" type="number" placeholder="e.g. 25">
          </label>

          <label>
            <span>University</span>
            <select id="uni"></select>
          </label>

          <label>
            <span>Food preference</span>
            <select id="food">
              <option value="25">Bare minimum (Â£25/week)</option>
              <option value="40">Balanced (Â£40/week)</option>
              <option value="60">Premium (Â£60/week)</option>
            </select>
          </label>

          <label>
            <span>Nights out per week</span>
            <input id="nights" type="number" placeholder="e.g. 2">
          </label>

          <button class="primary" id="calcBtn">Calculate</button>

          <div id="result" class="output"></div>
          <div id="tips" class="output tips"></div>

          <!-- Premium Insights (gated) -->
          <div class="card-lite" id="insightsBox">
            <div class="row-between">
              <strong>Spending breakdown</strong>
              <span class="muted small" id="insightsGateLabel">Premium feature</span>
            </div>

            <div id="insightsLocked" class="muted small">
              Upgrade to Premium to see a full breakdown + smart insights.
            </div>

            <div id="insights" style="display:none;">
              <div class="bar-row">
                <div class="bar-label">Nights out</div>
                <div class="bar-track"><div class="bar-fill" id="barNights"></div></div>
                <div class="bar-value" id="valNights"></div>
              </div>

              <div class="bar-row">
                <div class="bar-label">Food</div>
                <div class="bar-track"><div class="bar-fill" id="barFood"></div></div>
                <div class="bar-value" id="valFood"></div>
              </div>

              <div class="bar-row">
                <div class="bar-label">Subscriptions</div>
                <div class="bar-track"><div class="bar-fill" id="barSubs"></div></div>
                <div class="bar-value" id="valSubs"></div>
              </div>

              <div class="bar-row">
                <div class="bar-label">Money left</div>
                <div class="bar-track"><div class="bar-fill" id="barLeft"></div></div>
                <div class="bar-value" id="valLeft"></div>
              </div>

              <div class="muted small" id="insightText"></div>
            </div>
          </div>

          <!-- Save -->
          <button class="secondary" id="saveBudgetBtn" disabled>
            Save this budget to my account
          </button>
          <p class="muted small" id="saveHint">Sign in to save your budget.</p>
        </div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="page-account" class="page">
      <div class="card">
        <div class="row-between">
          <div>
            <h1>Account</h1>
            <p class="muted">Sign in to save, reload, and manage your preferences.</p>
          </div>
          <div class="pill" id="premiumPillAccount" style="display:none;">Premium</div>
        </div>

        <p id="user-status" class="muted">Not signed in</p>

        <div class="account-actions">
          <button class="primary" id="googleSignInBtn">Sign in with Google</button>
          <button class="secondary" id="logoutBtn" style="display:none;">Sign out</button>
        </div>

        <div class="divider"></div>

        <!-- Preferences -->
        <h2>Preferences</h2>
        <p class="muted small">Saved to your account and used to auto-fill the calculator.</p>

        <div class="form">
          <label>
            <span>Default university</span>
            <select id="prefUni"></select>
          </label>

          <label>
            <span>Default food preference</span>
            <select id="prefFood">
              <option value="25">Bare minimum (Â£25/week)</option>
              <option value="40">Balanced (Â£40/week)</option>
              <option value="60">Premium (Â£60/week)</option>
            </select>
          </label>

          <label>
            <span>Typical nights out per week</span>
            <input id="prefNights" type="number" placeholder="e.g. 2">
          </label>

          <label>
            <span>Typical subscriptions per month</span>
            <input id="prefSubs" type="number" placeholder="e.g. 25">
          </label>

          <button class="secondary" id="saveProfileBtn" disabled>
            Save preferences
          </button>

          <p class="muted small" id="profileHint">Sign in to save preferences.</p>
        </div>

        <div class="divider"></div>

        <!-- Budgets -->
        <h2>Budgets</h2>

        <button class="secondary" id="loadBudgetBtn" disabled>
          Load my last saved budget
        </button>
        <p class="muted small" id="loadHint">Sign in to load saved budgets.</p>
        <p class="muted small" id="loadStatus"></p>

        <!-- History (premium) -->
        <div class="card-lite" style="margin-top:14px;">
          <div class="row-between">
            <strong>Budget history</strong>
            <span class="muted small" id="historyGateLabel">Premium feature</span>
          </div>

          <div id="historyLocked" class="muted small">
            Upgrade to Premium to see all saved budgets and quick-load any one.
          </div>

          <div id="history" style="display:none;">
            <div id="historyList" class="history-list"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Premium -->
        <h2>Premium</h2>
        <p class="muted small">
          Subscribe to unlock insights + budget history. You can manage/cancel anytime.
        </p>

        <div class="premium-actions">
          <button class="primary" id="subscribeBtn" disabled>Subscribe to Premium</button>
          <button class="secondary" id="manageBtn" style="display:none;" disabled>Manage subscription</button>
          <p class="muted small" id="premiumStatusText">Sign in to subscribe.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       Stripe Price ID (REQUIRED)
       ========================= */
    const PRICE_ID = "price_1SilSr054mpSFuIv9nqPtASC"; // <-- your Stripe PRICE id (must start with price_)

    /* =========================
       Helpers + element refs
       ========================= */
    const el = (id) => document.getElementById(id);

    // Calculator
    const loan = el("loan");
    const wage = el("wage");
    const personal = el("personal");
    const subscriptions = el("subscriptions");
    const uni = el("uni");
    const food = el("food");
    const nights = el("nights");
    const calcBtn = el("calcBtn");
    const result = el("result");
    const tips = el("tips");

    // Premium insights
    const insightsGateLabel = el("insightsGateLabel");
    const insightsLocked = el("insightsLocked");
    const insights = el("insights");
    const barNights = el("barNights");
    const barFood = el("barFood");
    const barSubs = el("barSubs");
    const barLeft = el("barLeft");
    const valNights = el("valNights");
    const valFood = el("valFood");
    const valSubs = el("valSubs");
    const valLeft = el("valLeft");
    const insightText = el("insightText");

    // Account
    const userStatus = el("user-status");
    const googleSignInBtn = el("googleSignInBtn");
    const logoutBtn = el("logoutBtn");

    const saveBudgetBtn = el("saveBudgetBtn");
    const saveHint = el("saveHint");

    const loadBudgetBtn = el("loadBudgetBtn");
    const loadHint = el("loadHint");
    const loadStatus = el("loadStatus");

    const prefUni = el("prefUni");
    const prefFood = el("prefFood");
    const prefNights = el("prefNights");
    const prefSubs = el("prefSubs");
    const saveProfileBtn = el("saveProfileBtn");
    const profileHint = el("profileHint");

    // Premium buttons
    const subscribeBtn = el("subscribeBtn");
    const manageBtn = el("manageBtn");
    const premiumStatusText = el("premiumStatusText");

    // Premium pills / gating
    const premiumPill = el("premiumPill");
    const premiumPillAccount = el("premiumPillAccount");
    const historyGateLabel = el("historyGateLabel");
    const historyLocked = el("historyLocked");
    const history = el("history");
    const historyList = el("historyList");

    /* =========================
       State
       ========================= */
    let currentUser = null;
    let isPremium = false;
    let unsubSubListener = null;

    let universities = [];
    let cityCosts = {};
    let lastCalculated = null;

    /* =========================
       Auth
       ========================= */
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    function logout() {
      auth.signOut();
    }

    googleSignInBtn.addEventListener("click", loginWithGoogle);
    logoutBtn.addEventListener("click", logout);

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;

      if (!currentUser) {
        userStatus.innerText = "Not signed in";
        logoutBtn.style.display = "none";

        saveBudgetBtn.disabled = true;
        saveHint.innerText = "Sign in to save your budget.";

        loadBudgetBtn.disabled = true;
        loadHint.innerText = "Sign in to load saved budgets.";

        saveProfileBtn.disabled = true;
        profileHint.innerText = "Sign in to save preferences.";

        subscribeBtn.disabled = true;
        manageBtn.disabled = true;
        manageBtn.style.display = "none";
        premiumStatusText.innerText = "Sign in to subscribe.";

        if (typeof unsubSubListener === "function") unsubSubListener();
        setPremium(false);
        return;
      }

      userStatus.innerText = "Signed in as " + currentUser.displayName;
      logoutBtn.style.display = "inline-block";

      saveBudgetBtn.disabled = false;
      saveHint.innerText = "You can save budgets to your account.";

      loadBudgetBtn.disabled = false;
      loadHint.innerText = "Load your last saved budget anytime.";

      saveProfileBtn.disabled = false;
      profileHint.innerText = "Preferences will sync to your account.";

      subscribeBtn.disabled = false;
      premiumStatusText.innerText = "Checking subscriptionâ€¦";

      // Load user preferences (profile) from users/{uid}
      await loadProfile();

      // Listen to Stripe extension subscription status (customers/{uid}/subscriptions)
      listenToSubscriptionStatus();

      // Auto-load last budget silently
      await loadLastBudget(false);
    });

    /* =========================
       Premium gating
       ========================= */
    function setPremium(enabled) {
      isPremium = !!enabled;

      premiumPill.style.display = isPremium ? "inline-flex" : "none";
      premiumPillAccount.style.display = isPremium ? "inline-flex" : "none";

      // Insights gating
      insightsGateLabel.innerText = isPremium ? "Unlocked" : "Premium feature";
      insightsLocked.style.display = isPremium ? "none" : "block";
      insights.style.display = isPremium ? "block" : "none";

      // History gating
      historyGateLabel.innerText = isPremium ? "Unlocked" : "Premium feature";
      historyLocked.style.display = isPremium ? "none" : "block";
      history.style.display = isPremium ? "block" : "none";
    }

    function listenToSubscriptionStatus() {
      if (!currentUser) return;

      if (typeof unsubSubListener === "function") unsubSubListener();

      unsubSubListener = db
        .collection("customers")
        .doc(currentUser.uid)
        .collection("subscriptions")
        .onSnapshot((snap) => {
          const active = snap.docs.some(d => {
            const s = d.data();
            return s.status === "active" || s.status === "trialing";
          });

          setPremium(active);

          if (active) {
            manageBtn.style.display = "inline-flex";
            manageBtn.disabled = false;
            premiumStatusText.innerText = "Premium active âœ…";
            loadBudgetHistory();
          } else {
            manageBtn.style.display = "none";
            premiumStatusText.innerText = "Premium not active.";
          }
        }, (err) => {
          console.error(err);
          premiumStatusText.innerText = "Could not check subscription.";
          setPremium(false);
        });
    }

    /* =========================
       Stripe Extension: Subscribe + Portal
       ========================= */
    subscribeBtn.addEventListener("click", startPremiumCheckout);
    manageBtn.addEventListener("click", openCustomerPortal);

    async function startPremiumCheckout() {
      if (!currentUser) return alert("Please sign in first.");

      try {
        const docRef = await db
          .collection("customers")
          .doc(currentUser.uid)
          .collection("checkout_sessions")
          .add({
            mode: "subscription",
            price: PRICE_ID,
            success_url: window.location.href,
            cancel_url: window.location.href,
          });

        docRef.onSnapshot((snap) => {
          const data = snap.data();
          if (data?.error) alert(data.error.message || "Checkout error");
          if (data?.url) window.location.assign(data.url);
        });
      } catch (e) {
        console.error(e);
        alert("Could not start checkout: " + e.message);
      }
    }

    async function openCustomerPortal() {
      if (!currentUser) return alert("Please sign in first.");

      try {
        const fn = functions.httpsCallable("ext-firestore-stripe-payments-createPortalLink");
        const res = await fn({ returnUrl: window.location.href });

        if (res?.data?.url) window.location.assign(res.data.url);
        else alert("Could not open portal.");
      } catch (e) {
        console.error(e);
        alert("Portal error: " + e.message);
      }
    }

    /* =========================
       Universities data
       ========================= */
    Promise.all([
      fetch("universities.json").then(r => r.json()),
      fetch("cityCosts.json").then(r => r.json())
    ]).then(([u, c]) => {
      universities = u;
      cityCosts = c;

      uni.innerHTML = "";
      prefUni.innerHTML = "";

      universities.forEach((uniObj, i) => {
        const opt1 = document.createElement("option");
        opt1.value = i;
        opt1.textContent = uniObj.name;
        uni.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = i;
        opt2.textContent = uniObj.name;
        prefUni.appendChild(opt2);
      });
    }).catch(err => {
      console.error(err);
      uni.innerHTML = "<option>Failed to load universities</option>";
      prefUni.innerHTML = "<option>Failed to load universities</option>";
    });

    /* =========================
       Profile (preferences)
       ========================= */
    async function loadProfile() {
      if (!currentUser) return;

      const uid = currentUser.uid;
      const userDocRef = db.collection("users").doc(uid);
      const snap = await userDocRef.get();
      const data = snap.exists ? snap.data() : {};

      const profile = data.profile || {};

      // fill fields
      if (typeof profile.defaultUniIndex === "number") prefUni.value = profile.defaultUniIndex;
      if (profile.defaultFood != null) prefFood.value = String(profile.defaultFood);
      if (typeof profile.defaultNights === "number") prefNights.value = profile.defaultNights;
      if (typeof profile.defaultSubscriptions === "number") prefSubs.value = profile.defaultSubscriptions;

      // apply to calculator if empty
      applyPreferencesToCalculator(profile, { onlyIfEmpty: true });
    }

    saveProfileBtn.addEventListener("click", saveProfile);

    async function saveProfile() {
      if (!currentUser) return alert("Please sign in to save preferences.");

      const uid = currentUser.uid;
      const userDocRef = db.collection("users").doc(uid);

      const profile = {
        defaultUniIndex: Number(prefUni.value),
        defaultFood: Number(prefFood.value),
        defaultNights: Number(prefNights.value) || 0,
        defaultSubscriptions: Number(prefSubs.value) || 0,
        updatedAt: new Date().toISOString()
      };

      try {
        await userDocRef.set({ profile }, { merge: true });
        applyPreferencesToCalculator(profile, { onlyIfEmpty: false });
        alert("Preferences saved âœ…");
      } catch (e) {
        console.error(e);
        alert("Saving preferences failed: " + e.message);
      }
    }

    function applyPreferencesToCalculator(profile, opts) {
      const onlyIfEmpty = !!opts.onlyIfEmpty;

      if (typeof profile.defaultUniIndex === "number") {
        if (!onlyIfEmpty || uni.value === "" || uni.value == null) uni.value = profile.defaultUniIndex;
      }
      if (profile.defaultFood != null) {
        if (!onlyIfEmpty || food.value === "" || food.value == null) food.value = String(profile.defaultFood);
      }
      if (typeof profile.defaultNights === "number") {
        if (!onlyIfEmpty || !nights.value) nights.value = profile.defaultNights;
      }
      if (typeof profile.defaultSubscriptions === "number") {
        if (!onlyIfEmpty || !subscriptions.value) subscriptions.value = profile.defaultSubscriptions;
      }
    }

    /* =========================
       Calculator
       ========================= */
    calcBtn.addEventListener("click", calculateBudget);

    function calculateBudget() {
      const loanVal = Number(loan.value) || 0;
      const wageVal = Number(wage.value) || 0;
      const personalVal = Number(personal.value) || 0;
      const subsVal = Number(subscriptions.value) || 0;
      const nightsVal = Number(nights.value) || 0;

      const weeklyIncome = loanVal / 52 + wageVal / 4 + personalVal / 52;
      const weeklySubs = subsVal / 4;

      const uniObj = universities[Number(uni.value)];
      if (!uniObj) {
        result.innerText = "Please select a university.";
        tips.innerHTML = "";
        lastCalculated = null;
        return;
      }

      const nightCost = cityCosts[uniObj.city] || 0;
      const foodCost = Number(food.value) || 0;

      const nightTotal = nightsVal * nightCost;
      const balance = weeklyIncome - nightTotal - foodCost - weeklySubs;

      const status =
        balance < 0 ? "ðŸ”´ Overspending" :
        balance < 30 ? "ðŸŸ  Tight budget" :
        "ðŸŸ¢ Safe budget";

      result.innerText = `${status} â€“ Weekly balance Â£${balance.toFixed(2)}`;

      // Tips (free)
      let tipsText = "";
      if (weeklySubs > 10) tipsText += `â€¢ Subscriptions cost ~Â£${weeklySubs.toFixed(2)} per week.<br>`;
      if (nightsVal > 0 && nightCost > 0) tipsText += `â€¢ One fewer night out saves about Â£${nightCost} per week.<br>`;
      if (foodCost > 25) {
        const cheaperFood = (foodCost === 60) ? 40 : 25;
        tipsText += `â€¢ Cheaper food choice saves Â£${(foodCost - cheaperFood)} per week.<br>`;
      }
      tips.innerHTML = (balance < 30 && tipsText) ? `ðŸ’¡ <strong>Money-saving tips:</strong><br>${tipsText}` : "";

      // Premium insights
      if (isPremium) {
        const spent = Math.max(nightTotal + foodCost + weeklySubs, 0);
        const left = Math.max(weeklyIncome - spent, 0);
        const denom = Math.max(weeklyIncome, 1);

        setBar(barNights, nightTotal / denom);
        setBar(barFood, foodCost / denom);
        setBar(barSubs, weeklySubs / denom);
        setBar(barLeft, left / denom);

        valNights.innerText = `Â£${nightTotal.toFixed(2)}`;
        valFood.innerText = `Â£${foodCost.toFixed(2)}`;
        valSubs.innerText = `Â£${weeklySubs.toFixed(2)}`;
        valLeft.innerText = `Â£${left.toFixed(2)}`;

        const biggest = maxKey({ nights: nightTotal, food: foodCost, subs: weeklySubs });
        insightText.innerText =
          biggest === "nights" ? "Your biggest cost is nights out. Reducing by 1 night can make a big difference." :
          biggest === "food" ? "Your biggest cost is food. A lower food tier could stabilise your week." :
          "Your biggest cost is subscriptions. Consider cancelling what you donâ€™t use.";
      }

      lastCalculated = {
        createdAt: new Date().toISOString(),
        inputs: {
          loanPerYear: loanVal,
          wagePerMonth: wageVal,
          personalFunds: personalVal,
          subscriptionsPerMonth: subsVal,
          nightsOutPerWeek: nightsVal,
          foodPerWeek: foodCost,
          uniIndex: Number(uni.value),
          uniName: uniObj.name,
          city: uniObj.city
        },
        derived: {
          nightCostPerNight: nightCost,
          weeklyIncome: Number(weeklyIncome.toFixed(2)),
          weeklySubscriptions: Number(weeklySubs.toFixed(2)),
          weeklyNightTotal: Number(nightTotal.toFixed(2)),
          weeklyBalance: Number(balance.toFixed(2))
        }
      };
    }

    function setBar(node, ratio) {
      const pct = Math.max(0, Math.min(1, ratio)) * 100;
      node.style.width = pct.toFixed(1) + "%";
    }

    function maxKey(obj) {
      let bestK = null, bestV = -Infinity;
      for (const k in obj) {
        if (obj[k] > bestV) { bestV = obj[k]; bestK = k; }
      }
      return bestK;
    }

    /* =========================
       Save / Load budgets
       ========================= */
    saveBudgetBtn.addEventListener("click", saveBudget);
    loadBudgetBtn.addEventListener("click", () => loadLastBudget(true));

    async function saveBudget() {
      if (!currentUser) return alert("Please sign in to save your budget.");
      if (!lastCalculated) return alert("Calculate your budget first, then save it.");

      try {
        await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .add({
            ...lastCalculated,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        alert("Saved âœ…");
        if (isPremium) loadBudgetHistory();
      } catch (e) {
        console.error(e);
        alert("Saving failed: " + e.message);
      }
    }

    async function loadLastBudget(showUI) {
      if (!currentUser) return;

      if (showUI) loadStatus.innerText = "Loadingâ€¦";

      try {
        const snap = await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .orderBy("savedAt", "desc")
          .limit(1)
          .get();

        if (snap.empty) {
          if (showUI) loadStatus.innerText = "No saved budgets yet.";
          return;
        }

        const data = snap.docs[0].data();

        loan.value = data.inputs?.loanPerYear ?? 0;
        wage.value = data.inputs?.wagePerMonth ?? 0;
        personal.value = data.inputs?.personalFunds ?? 0;
        subscriptions.value = data.inputs?.subscriptionsPerMonth ?? 0;
        nights.value = data.inputs?.nightsOutPerWeek ?? 0;
        food.value = String(data.inputs?.foodPerWeek ?? 25);

        if (typeof data.inputs?.uniIndex === "number") uni.value = data.inputs.uniIndex;

        calculateBudget();

        if (showUI) {
          loadStatus.innerText = "Loaded âœ…";
          showPage("calculator");
        }
      } catch (e) {
        console.error(e);
        if (showUI) loadStatus.innerText = "";
        if (showUI) alert("Load failed: " + e.message);
      }
    }

    /* =========================
       Budget history (Premium)
       ========================= */
    async function loadBudgetHistory() {
      if (!currentUser || !isPremium) return;

      historyList.innerHTML = `<div class="muted small">Loading historyâ€¦</div>`;

      try {
        const snap = await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .orderBy("savedAt", "desc")
          .limit(10)
          .get();

        if (snap.empty) {
          historyList.innerHTML = `<div class="muted small">No saved budgets yet.</div>`;
          return;
        }

        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          const ts = d.savedAt?.toDate ? d.savedAt.toDate() : null;
          const when = ts ? ts.toLocaleString() : (d.createdAt || "Saved");
          const balance = d.derived?.weeklyBalance ?? 0;
          const uniName = d.inputs?.uniName ?? "University";

          rows.push(`
            <div class="history-item">
              <div>
                <div class="history-title">${escapeHtml(uniName)}</div>
                <div class="muted small">${escapeHtml(when)}</div>
              </div>
              <div class="history-right">
                <div class="history-balance">Â£${Number(balance).toFixed(2)}</div>
                <button class="secondary history-btn" data-budget-id="${doc.id}">Load</button>
              </div>
            </div>
          `);
        });

        historyList.innerHTML = rows.join("");

        // attach load handlers
        historyList.querySelectorAll("button[data-budget-id]").forEach(btn => {
          btn.addEventListener("click", () => loadBudgetById(btn.getAttribute("data-budget-id")));
        });

      } catch (e) {
        console.error(e);
        historyList.innerHTML = `<div class="muted small">Failed to load history.</div>`;
      }
    }

    async function loadBudgetById(docId) {
      if (!currentUser || !isPremium) return;

      try {
        const docRef = db.collection("users").doc(currentUser.uid).collection("budgets").doc(docId);
        const snap = await docRef.get();
        if (!snap.exists) return;

        const data = snap.data();

        loan.value = data.inputs?.loanPerYear ?? 0;
        wage.value = data.inputs?.wagePerMonth ?? 0;
        personal.value = data.inputs?.personalFunds ?? 0;
        subscriptions.value = data.inputs?.subscriptionsPerMonth ?? 0;
        nights.value = data.inputs?.nightsOutPerWeek ?? 0;
        food.value = String(data.inputs?.foodPerWeek ?? 25);
        if (typeof data.inputs?.uniIndex === "number") uni.value = data.inputs.uniIndex;

        calculateBudget();
        showPage("calculator");
      } catch (e) {
        console.error(e);
        alert("Load failed: " + e.message);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    /* =========================
       Navigation
       ========================= */
    const pages = ["home", "calculator", "account"];
    document.querySelectorAll(".nav-link").forEach(btn => {
      btn.addEventListener("click", () => showPage(btn.dataset.page));
    });

    function showPage(p) {
      pages.forEach(x => el("page-" + x).classList.toggle("active", x === p));
      document.querySelectorAll(".nav-link").forEach(b => b.classList.toggle("active", b.dataset.page === p));
      window.scrollTo(0, 0);
    }

    el("go-calc").addEventListener("click", () => showPage("calculator"));
    el("go-account").addEventListener("click", () => showPage("account"));
  </script>
</body>
</html>



