<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Univio â€“ Student Budgeting</title>

  <link rel="stylesheet" href="style.css">

  <!-- Firebase (compat SDK for plain HTML + GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBnn-u991pW4m3En3AlmpIPCplZ9ev4TOA",
      authDomain: "uni-budget-app.firebaseapp.com",
      projectId: "uni-budget-app",
      storageBucket: "uni-budget-app.firebasestorage.app",
      messagingSenderId: "807550470586",
      appId: "1:807550470586:web:09c16fa0fe008653917583"
    };

    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    window.functions = firebase.functions();
  </script>
</head>

<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="brand">
      <img src="logo.svg" alt="Univio logo" class="logo-img">
      <span class="brand-name">Univio</span>
    </div>

    <nav class="nav">
      <button class="nav-link active" data-page="home">Home</button>
      <button class="nav-link" data-page="calculator">Calculate</button>
      <button class="nav-link" data-page="account">Account</button>
    </nav>
  </header>

  <main class="shell">
    <!-- HOME -->
    <section id="page-home" class="page active">
      <div class="card">
        <h1>Student budgeting, simplified.</h1>
        <p class="muted">
          Plan weekly spending using income, subscriptions, university city costs and nights out.
          Sign in to save. Premium unlocks term forecasting, scenario comparisons, subscription insights and exports.
        </p>

        <div class="home-actions">
          <button class="primary" id="go-calc">Calculate my budget</button>
          <button class="secondary" id="go-account">Sign in</button>
        </div>

        <div class="notice">
          <strong>Premium includes:</strong> budget history + what-if scenarios + term forecast + subscription manager + challenges + export.
        </div>
      </div>
    </section>

    <!-- CALCULATOR -->
    <section id="page-calculator" class="page">
      <div class="card">
        <div class="row-between">
          <div>
            <h1>Calculate budget</h1>
            <p class="muted">Weekly estimate based on your inputs.</p>
          </div>
          <div class="pill" id="premiumPill" style="display:none;">Premium</div>
        </div>

        <!-- BASE FORM -->
        <div class="form">
          <label>
            <span>Student loan (per year)</span>
            <input id="loan" type="number" placeholder="e.g. 9000">
          </label>

          <label>
            <span>Monthly wage</span>
            <input id="wage" type="number" placeholder="e.g. 450">
          </label>

          <label>
            <span>Personal funds</span>
            <input id="personal" type="number" placeholder="e.g. 500">
          </label>

          <label>
            <span>University</span>
            <select id="uni"></select>
          </label>

          <label>
            <span>Food preference</span>
            <select id="food">
              <option value="25">Bare minimum (Â£25/week)</option>
              <option value="40">Balanced (Â£40/week)</option>
              <option value="60">Premium (Â£60/week)</option>
            </select>
          </label>

          <label>
            <span>Nights out per week</span>
            <input id="nights" type="number" placeholder="e.g. 2">
          </label>

          <!-- Free: Single monthly subscriptions input (simple) -->
          <label>
            <span>Monthly subscriptions (quick total)</span>
            <input id="subscriptionsQuick" type="number" placeholder="e.g. 25">
          </label>

          <button class="primary" id="calcBtn">Calculate</button>

          <div id="result" class="output"></div>
          <div id="tips" class="output tips"></div>

          <!-- FREE EXPORT (basic): last calculation CSV -->
          <div class="card-lite">
            <div class="row-between">
              <strong>Export</strong>
              <span class="muted small">Free</span>
            </div>
            <p class="muted small">Download a CSV of your latest calculation.</p>
            <button class="secondary" id="exportCsvBtn">Download CSV</button>
          </div>

          <!-- SAVE -->
          <button class="secondary" id="saveBudgetBtn" disabled>
            Save this budget to my account
          </button>
          <p class="muted small" id="saveHint">Sign in to save your budget.</p>
        </div>

        <!-- PREMIUM FEATURES -->
        <div class="divider"></div>

        <div class="card-lite">
          <div class="row-between">
            <strong>Premium features</strong>
            <span class="muted small" id="premiumGateLabelCalc">Premium feature</span>
          </div>

          <div id="premiumLockedCalc" class="muted small">
            Subscribe to Premium to unlock term forecasting, scenarios, subscription manager, challenges, insights and history.
          </div>

          <div id="premiumAreaCalc" style="display:none;">
            <!-- PREMIUM: Subscription manager -->
            <div class="card-lite" style="margin-top:12px;">
              <div class="row-between">
                <strong>Subscription manager</strong>
                <span class="muted small" id="subsWeeklyTotal">Weekly: Â£0.00</span>
              </div>

              <div class="grid-2" style="margin-top:10px;">
                <label>
                  <span>Subscription name</span>
                  <input id="subName" type="text" placeholder="e.g. Spotify">
                </label>
                <label>
                  <span>Monthly cost (Â£)</span>
                  <input id="subCost" type="number" placeholder="e.g. 10.99">
                </label>
              </div>

              <button class="secondary" id="addSubBtn" style="margin-top:10px;">Add subscription</button>

              <div id="subsList" class="history-list" style="margin-top:10px;"></div>
              <p class="muted small" id="subsInsight"></p>
            </div>

            <!-- PREMIUM: Advanced breakdown + insights -->
            <div class="card-lite" style="margin-top:12px;">
              <div class="row-between">
                <strong>Spending breakdown</strong>
                <span class="muted small">Premium</span>
              </div>

              <div style="margin-top:10px;">
                <div class="bar-row">
                  <div class="bar-label">Nights out</div>
                  <div class="bar-track"><div class="bar-fill" id="barNights"></div></div>
                  <div class="bar-value" id="valNights"></div>
                </div>

                <div class="bar-row">
                  <div class="bar-label">Food</div>
                  <div class="bar-track"><div class="bar-fill" id="barFood"></div></div>
                  <div class="bar-value" id="valFood"></div>
                </div>

                <div class="bar-row">
                  <div class="bar-label">Subscriptions</div>
                  <div class="bar-track"><div class="bar-fill" id="barSubs"></div></div>
                  <div class="bar-value" id="valSubs"></div>
                </div>

                <div class="bar-row">
                  <div class="bar-label">Money left</div>
                  <div class="bar-track"><div class="bar-fill" id="barLeft"></div></div>
                  <div class="bar-value" id="valLeft"></div>
                </div>

                <div class="muted small" id="insightText" style="margin-top:8px;"></div>
              </div>
            </div>

            <!-- PREMIUM: Term forecast -->
            <div class="card-lite" style="margin-top:12px;">
              <div class="row-between">
                <strong>Term forecast</strong>
                <span class="muted small">Premium</span>
              </div>

              <div class="grid-2" style="margin-top:10px;">
                <label>
                  <span>Weeks left in term</span>
                  <input id="termWeeks" type="number" placeholder="e.g. 12">
                </label>
                <label>
                  <span>Start date (optional)</span>
                  <input id="termStart" type="date">
                </label>
              </div>

              <button class="secondary" id="termForecastBtn" style="margin-top:10px;">Run forecast</button>

              <div id="termResult" class="output" style="margin-top:10px;"></div>
              <button class="secondary" id="exportTermCsvBtn" style="margin-top:10px;">Download term summary CSV</button>
            </div>

            <!-- PREMIUM: What-if scenarios -->
            <div class="card-lite" style="margin-top:12px;">
              <div class="row-between">
                <strong>What-if scenarios</strong>
                <span class="muted small">Premium</span>
              </div>

              <p class="muted small" style="margin-top:6px;">
                Compare choices instantly without changing your saved inputs.
              </p>

              <div class="scenario-grid" style="margin-top:10px;">
                <label class="checkline">
                  <input type="checkbox" id="scnOneLessNight">
                  <span>1 fewer night out per week</span>
                </label>

                <label class="checkline">
                  <input type="checkbox" id="scnCheaperFood">
                  <span>Switch to cheaper food tier</span>
                </label>

                <label class="checkline">
                  <input type="checkbox" id="scnCutSubs20">
                  <span>Reduce subscriptions by 20%</span>
                </label>

                <label class="checkline">
                  <input type="checkbox" id="scnNoUbers">
                  <span>Replace 1 Uber/week with walking</span>
                </label>
              </div>

              <label style="margin-top:10px;">
                <span>Uber cost per trip (Â£) (for scenarios)</span>
                <input id="uberCost" type="number" placeholder="e.g. 8">
              </label>

              <button class="secondary" id="runScenariosBtn" style="margin-top:10px;">Compare scenarios</button>

              <div id="scenarioResult" class="output" style="margin-top:10px;"></div>
            </div>

            <!-- PREMIUM: Savings challenges -->
            <div class="card-lite" style="margin-top:12px;">
              <div class="row-between">
                <strong>Savings challenges</strong>
                <span class="muted small">Premium</span>
              </div>

              <div class="grid-2" style="margin-top:10px;">
                <label>
                  <span>Goal (Â£)</span>
                  <input id="challengeGoal" type="number" placeholder="e.g. 100">
                </label>
                <label>
                  <span>Deadline (weeks)</span>
                  <input id="challengeWeeks" type="number" placeholder="e.g. 10">
                </label>
              </div>

              <label style="margin-top:10px;">
                <span>Already saved (Â£)</span>
                <input id="challengeSaved" type="number" placeholder="e.g. 20">
              </label>

              <button class="secondary" id="challengeBtn" style="margin-top:10px;">Generate plan</button>
              <div id="challengeResult" class="output" style="margin-top:10px;"></div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="page-account" class="page">
      <div class="card">
        <div class="row-between">
          <div>
            <h1>Account</h1>
            <p class="muted">Sign in to save, reload, and manage your preferences.</p>
          </div>
          <div class="pill" id="premiumPillAccount" style="display:none;">Premium</div>
        </div>

        <p id="user-status" class="muted">Not signed in</p>

        <div class="account-actions">
          <button class="primary" id="googleSignInBtn">Sign in with Google</button>
          <button class="secondary" id="logoutBtn" style="display:none;">Sign out</button>
        </div>

        <div class="divider"></div>

        <!-- Preferences -->
        <h2>Preferences</h2>
        <p class="muted small">Saved to your account and used to auto-fill the calculator.</p>

        <div class="form">
          <label>
            <span>Default university</span>
            <select id="prefUni"></select>
          </label>

          <label>
            <span>Default food preference</span>
            <select id="prefFood">
              <option value="25">Bare minimum (Â£25/week)</option>
              <option value="40">Balanced (Â£40/week)</option>
              <option value="60">Premium (Â£60/week)</option>
            </select>
          </label>

          <label>
            <span>Typical nights out per week</span>
            <input id="prefNights" type="number" placeholder="e.g. 2">
          </label>

          <label>
            <span>Typical subscriptions per month</span>
            <input id="prefSubs" type="number" placeholder="e.g. 25">
          </label>

          <button class="secondary" id="saveProfileBtn" disabled>Save preferences</button>
          <p class="muted small" id="profileHint">Sign in to save preferences.</p>
        </div>

        <div class="divider"></div>

        <!-- Budgets -->
        <h2>Budgets</h2>
        <button class="secondary" id="loadBudgetBtn" disabled>Load my last saved budget</button>
        <p class="muted small" id="loadHint">Sign in to load saved budgets.</p>
        <p class="muted small" id="loadStatus"></p>

        <!-- History (Premium unlimited; free = last only) -->
        <div class="card-lite" style="margin-top:14px;">
          <div class="row-between">
            <strong>Budget history</strong>
            <span class="muted small" id="historyGateLabel">Premium feature</span>
          </div>

          <div id="historyLocked" class="muted small">
            Premium unlocks budget history + quick-load any previous budget.
          </div>

          <div id="history" style="display:none;">
            <div id="historyList" class="history-list"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Premium (Stripe Extension buttons) -->
        <h2>Premium</h2>
        <p class="muted small">
          Subscribe to unlock: term forecast, what-if scenarios, subscription manager, challenges, insights, and full history.
        </p>

        <div class="premium-actions">
          <button class="primary" id="subscribeBtn" disabled>Subscribe to Premium</button>
          <button class="secondary" id="manageBtn" style="display:none;" disabled>Manage subscription</button>
          <p class="muted small" id="premiumStatusText">Sign in to subscribe.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       Stripe Price ID (REQUIRED)
       ========================= */
    const PRICE_ID = "price_1SilSr054mpSFuIv9nqPtASC"; // <-- replace with your LIVE price later

    /* =========================
       Helpers + element refs
       ========================= */
    const el = (id) => document.getElementById(id);
    const fmt = (n) => "Â£" + Number(n || 0).toFixed(2);
    const clamp01 = (x) => Math.max(0, Math.min(1, x));

    // Base inputs
    const loan = el("loan");
    const wage = el("wage");
    const personal = el("personal");
    const uni = el("uni");
    const food = el("food");
    const nights = el("nights");
    const subscriptionsQuick = el("subscriptionsQuick");

    // Buttons/outputs
    const calcBtn = el("calcBtn");
    const result = el("result");
    const tips = el("tips");
    const exportCsvBtn = el("exportCsvBtn");

    const saveBudgetBtn = el("saveBudgetBtn");
    const saveHint = el("saveHint");

    // Premium wrapper
    const premiumPill = el("premiumPill");
    const premiumPillAccount = el("premiumPillAccount");
    const premiumGateLabelCalc = el("premiumGateLabelCalc");
    const premiumLockedCalc = el("premiumLockedCalc");
    const premiumAreaCalc = el("premiumAreaCalc");

    // Premium: subs
    const subName = el("subName");
    const subCost = el("subCost");
    const addSubBtn = el("addSubBtn");
    const subsList = el("subsList");
    const subsWeeklyTotal = el("subsWeeklyTotal");
    const subsInsight = el("subsInsight");

    // Premium: breakdown bars
    const barNights = el("barNights");
    const barFood = el("barFood");
    const barSubs = el("barSubs");
    const barLeft = el("barLeft");
    const valNights = el("valNights");
    const valFood = el("valFood");
    const valSubs = el("valSubs");
    const valLeft = el("valLeft");
    const insightText = el("insightText");

    // Premium: term forecast
    const termWeeks = el("termWeeks");
    const termStart = el("termStart");
    const termForecastBtn = el("termForecastBtn");
    const termResult = el("termResult");
    const exportTermCsvBtn = el("exportTermCsvBtn");

    // Premium: scenarios
    const scnOneLessNight = el("scnOneLessNight");
    const scnCheaperFood = el("scnCheaperFood");
    const scnCutSubs20 = el("scnCutSubs20");
    const scnNoUbers = el("scnNoUbers");
    const uberCost = el("uberCost");
    const runScenariosBtn = el("runScenariosBtn");
    const scenarioResult = el("scenarioResult");

    // Premium: challenges
    const challengeGoal = el("challengeGoal");
    const challengeWeeks = el("challengeWeeks");
    const challengeSaved = el("challengeSaved");
    const challengeBtn = el("challengeBtn");
    const challengeResult = el("challengeResult");

    // Account page
    const userStatus = el("user-status");
    const googleSignInBtn = el("googleSignInBtn");
    const logoutBtn = el("logoutBtn");

    const prefUni = el("prefUni");
    const prefFood = el("prefFood");
    const prefNights = el("prefNights");
    const prefSubs = el("prefSubs");
    const saveProfileBtn = el("saveProfileBtn");
    const profileHint = el("profileHint");

    const loadBudgetBtn = el("loadBudgetBtn");
    const loadHint = el("loadHint");
    const loadStatus = el("loadStatus");

    // History
    const historyGateLabel = el("historyGateLabel");
    const historyLocked = el("historyLocked");
    const history = el("history");
    const historyList = el("historyList");

    // Premium subscribe
    const subscribeBtn = el("subscribeBtn");
    const manageBtn = el("manageBtn");
    const premiumStatusText = el("premiumStatusText");

    /* =========================
       State
       ========================= */
    let currentUser = null;
    let isPremium = false;
    let unsubSubListener = null;

    let universities = [];
    let cityCosts = {};

    // Premium: subscription items
    let subItems = []; // [{name, monthlyCost}]
    // Last calc snapshot
    let lastCalculated = null;

    /* =========================
       Auth
       ========================= */
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => alert(e.message));
    }
    function logout() { auth.signOut(); }

    googleSignInBtn.addEventListener("click", loginWithGoogle);
    logoutBtn.addEventListener("click", logout);

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;

      if (!currentUser) {
        userStatus.innerText = "Not signed in";
        logoutBtn.style.display = "none";

        saveBudgetBtn.disabled = true;
        saveHint.innerText = "Sign in to save your budget.";

        loadBudgetBtn.disabled = true;
        loadHint.innerText = "Sign in to load saved budgets.";

        saveProfileBtn.disabled = true;
        profileHint.innerText = "Sign in to save preferences.";

        subscribeBtn.disabled = true;
        manageBtn.disabled = true;
        manageBtn.style.display = "none";
        premiumStatusText.innerText = "Sign in to subscribe.";

        if (typeof unsubSubListener === "function") unsubSubListener();
        setPremium(false);
        return;
      }

      userStatus.innerText = "Signed in as " + currentUser.displayName;
      logoutBtn.style.display = "inline-block";

      saveBudgetBtn.disabled = false;
      saveHint.innerText = "You can save budgets to your account.";

      loadBudgetBtn.disabled = false;
      loadHint.innerText = "Load your last saved budget anytime.";

      saveProfileBtn.disabled = false;
      profileHint.innerText = "Preferences will sync to your account.";

      subscribeBtn.disabled = false;
      premiumStatusText.innerText = "Checking subscriptionâ€¦";

      // Load preferences
      await loadProfile();

      // Listen to Stripe subscription
      listenToSubscriptionStatus();

      // Auto-load last budget silently
      await loadLastBudget(false);

      // Load premium subscription items if premium
      await loadPremiumSubItems();
    });

    /* =========================
       Premium gating
       ========================= */
    function setPremium(enabled) {
      isPremium = !!enabled;

      premiumPill.style.display = isPremium ? "inline-flex" : "none";
      premiumPillAccount.style.display = isPremium ? "inline-flex" : "none";

      premiumGateLabelCalc.innerText = isPremium ? "Unlocked" : "Premium feature";
      premiumLockedCalc.style.display = isPremium ? "none" : "block";
      premiumAreaCalc.style.display = isPremium ? "block" : "none";

      historyGateLabel.innerText = isPremium ? "Unlocked" : "Premium feature";
      historyLocked.style.display = isPremium ? "none" : "block";
      history.style.display = isPremium ? "block" : "none";
    }

    function listenToSubscriptionStatus() {
      if (!currentUser) return;

      if (typeof unsubSubListener === "function") unsubSubListener();

      unsubSubListener = db
        .collection("customers")
        .doc(currentUser.uid)
        .collection("subscriptions")
        .onSnapshot((snap) => {
          const active = snap.docs.some(d => {
            const s = d.data();
            return s.status === "active" || s.status === "trialing";
          });

          setPremium(active);

          if (active) {
            manageBtn.style.display = "inline-flex";
            manageBtn.disabled = false;
            premiumStatusText.innerText = "Premium active âœ…";
            loadBudgetHistory();
            loadPremiumSubItems();
          } else {
            manageBtn.style.display = "none";
            premiumStatusText.innerText = "Premium not active.";
          }
        }, (err) => {
          console.error(err);
          premiumStatusText.innerText = "Could not check subscription.";
          setPremium(false);
        });
    }

    /* =========================
       Stripe Extension: Subscribe + Portal
       ========================= */
    subscribeBtn.addEventListener("click", startPremiumCheckout);
    manageBtn.addEventListener("click", openCustomerPortal);

    async function startPremiumCheckout() {
      if (!currentUser) return alert("Please sign in first.");
      try {
        const docRef = await db
          .collection("customers")
          .doc(currentUser.uid)
          .collection("checkout_sessions")
          .add({
            mode: "subscription",
            price: PRICE_ID,
            success_url: window.location.href,
            cancel_url: window.location.href,
          });

        docRef.onSnapshot((snap) => {
          const data = snap.data();
          if (data?.error) alert(data.error.message || "Checkout error");
          if (data?.url) window.location.assign(data.url);
        });
      } catch (e) {
        console.error(e);
        alert("Could not start checkout: " + e.message);
      }
    }

    async function openCustomerPortal() {
      if (!currentUser) return alert("Please sign in first.");
      try {
        const fn = functions.httpsCallable("ext-firestore-stripe-payments-createPortalLink");
        const res = await fn({ returnUrl: window.location.href });
        if (res?.data?.url) window.location.assign(res.data.url);
        else alert("Could not open portal.");
      } catch (e) {
        console.error(e);
        alert("Portal error: " + e.message);
      }
    }

    /* =========================
       Universities data
       ========================= */
    Promise.all([
      fetch("universities.json").then(r => r.json()),
      fetch("cityCosts.json").then(r => r.json())
    ]).then(([u, c]) => {
      universities = u;
      cityCosts = c;

      uni.innerHTML = "";
      prefUni.innerHTML = "";

      universities.forEach((uniObj, i) => {
        const opt1 = document.createElement("option");
        opt1.value = i;
        opt1.textContent = uniObj.name;
        uni.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = i;
        opt2.textContent = uniObj.name;
        prefUni.appendChild(opt2);
      });
    }).catch(err => {
      console.error(err);
      uni.innerHTML = "<option>Failed to load universities</option>";
      prefUni.innerHTML = "<option>Failed to load universities</option>";
    });

    /* =========================
       Profile (preferences)
       ========================= */
    async function loadProfile() {
      if (!currentUser) return;

      const uid = currentUser.uid;
      const userDocRef = db.collection("users").doc(uid);
      const snap = await userDocRef.get();
      const data = snap.exists ? snap.data() : {};

      const profile = data.profile || {};

      if (typeof profile.defaultUniIndex === "number") prefUni.value = profile.defaultUniIndex;
      if (profile.defaultFood != null) prefFood.value = String(profile.defaultFood);
      if (typeof profile.defaultNights === "number") prefNights.value = profile.defaultNights;
      if (typeof profile.defaultSubscriptions === "number") prefSubs.value = profile.defaultSubscriptions;

      applyPreferencesToCalculator(profile, { onlyIfEmpty: true });
    }

    saveProfileBtn.addEventListener("click", saveProfile);

    async function saveProfile() {
      if (!currentUser) return alert("Please sign in to save preferences.");

      const uid = currentUser.uid;
      const userDocRef = db.collection("users").doc(uid);

      const profile = {
        defaultUniIndex: Number(prefUni.value),
        defaultFood: Number(prefFood.value),
        defaultNights: Number(prefNights.value) || 0,
        defaultSubscriptions: Number(prefSubs.value) || 0,
        updatedAt: new Date().toISOString()
      };

      try {
        await userDocRef.set({ profile }, { merge: true });

        applyPreferencesToCalculator(profile, { onlyIfEmpty: false });
        alert("Preferences saved âœ…");
      } catch (e) {
        console.error(e);
        alert("Saving preferences failed: " + e.message);
      }
    }

    function applyPreferencesToCalculator(profile, opts) {
      const onlyIfEmpty = !!opts.onlyIfEmpty;

      if (typeof profile.defaultUniIndex === "number") {
        if (!onlyIfEmpty || uni.value === "" || uni.value == null) uni.value = profile.defaultUniIndex;
      }
      if (profile.defaultFood != null) {
        if (!onlyIfEmpty || food.value === "" || food.value == null) food.value = String(profile.defaultFood);
      }
      if (typeof profile.defaultNights === "number") {
        if (!onlyIfEmpty || !nights.value) nights.value = profile.defaultNights;
      }
      if (typeof profile.defaultSubscriptions === "number") {
        if (!onlyIfEmpty || !subscriptionsQuick.value) subscriptionsQuick.value = profile.defaultSubscriptions;
      }
    }

    /* =========================
       Premium: subscription manager data in Firestore
       Stored under users/{uid}/subscriptionItems
       ========================= */
    async function loadPremiumSubItems() {
      if (!currentUser || !isPremium) return;

      try {
        const snap = await db.collection("users")
          .doc(currentUser.uid)
          .collection("subscriptionItems")
          .orderBy("createdAt", "asc")
          .get();

        subItems = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .map(x => ({ id: x.id, name: x.name || "Subscription", monthlyCost: Number(x.monthlyCost || 0) }));

        renderSubItems();
      } catch (e) {
        console.error(e);
        subItems = [];
        renderSubItems();
      }
    }

    addSubBtn.addEventListener("click", async () => {
      if (!isPremium) return alert("Premium required for subscription manager.");
      if (!currentUser) return alert("Sign in first.");

      const name = (subName.value || "").trim();
      const cost = Number(subCost.value || 0);

      if (!name) return alert("Enter a subscription name.");
      if (cost <= 0) return alert("Enter a monthly cost.");

      try {
        await db.collection("users")
          .doc(currentUser.uid)
          .collection("subscriptionItems")
          .add({
            name,
            monthlyCost: cost,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        subName.value = "";
        subCost.value = "";
        await loadPremiumSubItems();
        calculateBudget(); // refresh premium totals
      } catch (e) {
        console.error(e);
        alert("Could not add subscription: " + e.message);
      }
    });

    async function deleteSubItem(id) {
      if (!currentUser) return;
      try {
        await db.collection("users").doc(currentUser.uid).collection("subscriptionItems").doc(id).delete();
        await loadPremiumSubItems();
        calculateBudget();
      } catch (e) {
        console.error(e);
        alert("Could not remove subscription.");
      }
    }

    function renderSubItems() {
      subsList.innerHTML = "";
      const weeklyTotal = getPremiumSubsWeeklyTotal();
      subsWeeklyTotal.innerText = "Weekly: " + fmt(weeklyTotal);

      if (!subItems.length) {
        subsList.innerHTML = `<div class="muted small">No subscriptions added yet.</div>`;
        subsInsight.innerText = "";
        return;
      }

      // biggest subscription insight
      const biggest = subItems.reduce((a, b) => (b.monthlyCost > a.monthlyCost ? b : a), subItems[0]);
      subsInsight.innerText = `Biggest subscription: ${biggest.name} (${fmt(biggest.monthlyCost)}/month).`;

      const rows = subItems.map(item => `
        <div class="history-item">
          <div>
            <div class="history-title">${escapeHtml(item.name)}</div>
            <div class="muted small">${fmt(item.monthlyCost)}/month (~${fmt(item.monthlyCost/4)}/week)</div>
          </div>
          <div class="history-right">
            <button class="secondary history-btn" data-sub-id="${item.id}">Remove</button>
          </div>
        </div>
      `);

      subsList.innerHTML = rows.join("");
      subsList.querySelectorAll("button[data-sub-id]").forEach(btn => {
        btn.addEventListener("click", () => deleteSubItem(btn.getAttribute("data-sub-id")));
      });
    }

    function getPremiumSubsWeeklyTotal() {
      if (!isPremium) return 0;
      return subItems.reduce((sum, x) => sum + (Number(x.monthlyCost || 0) / 4), 0);
    }

    /* =========================
       Calculator + insights
       ========================= */
    calcBtn.addEventListener("click", calculateBudget);

    function calculateBudget() {
      const loanVal = Number(loan.value) || 0;
      const wageVal = Number(wage.value) || 0;
      const personalVal = Number(personal.value) || 0;
      const nightsVal = Number(nights.value) || 0;
      const foodCost = Number(food.value) || 0;

      const weeklyIncome = loanVal / 52 + wageVal / 4 + personalVal / 52;

      const uniObj = universities[Number(uni.value)];
      if (!uniObj) {
        result.innerText = "Please select a university.";
        tips.innerHTML = "";
        lastCalculated = null;
        return;
      }

      const nightCost = Number(cityCosts[uniObj.city] || 0);
      const nightTotal = nightsVal * nightCost;

      // Subscriptions:
      // Free uses subscriptionsQuick; Premium uses detailed list + still includes quick if user wants
      const quickMonthly = Number(subscriptionsQuick.value || 0);
      const quickWeekly = quickMonthly / 4;
      const premiumWeekly = getPremiumSubsWeeklyTotal();
      const subsWeekly = isPremium ? Math.max(quickWeekly, premiumWeekly) : quickWeekly; 
      // (If premium user uses both, take the larger to avoid double counting. You can change this later.)

      const weeklySpent = nightTotal + foodCost + subsWeekly;
      const balance = weeklyIncome - weeklySpent;

      // FREE messages
      const status =
        balance < 0 ? "ðŸ”´ Overspending" :
        balance < 30 ? "ðŸŸ  Tight budget" :
        "ðŸŸ¢ Safe budget";

      result.innerText = `${status} â€“ Weekly balance ${fmt(balance)}`;

      // Free tips
      let tipsText = "";
      if (subsWeekly > 10) tipsText += `â€¢ Subscriptions cost ~${fmt(subsWeekly)} per week.<br>`;
      if (nightsVal > 0 && nightCost > 0) tipsText += `â€¢ One fewer night out saves about ${fmt(nightCost)} per week.<br>`;
      if (foodCost > 25) {
        const cheaperFood = (foodCost === 60) ? 40 : 25;
        tipsText += `â€¢ Cheaper food choice saves ${fmt(foodCost - cheaperFood)} per week.<br>`;
      }
      tips.innerHTML = (balance < 30 && tipsText) ? `ðŸ’¡ <strong>Money-saving tips:</strong><br>${tipsText}` : "";

      // PREMIUM: breakdown + insight
      if (isPremium) {
        const spent = Math.max(weeklySpent, 0);
        const left = Math.max(weeklyIncome - spent, 0);
        const denom = Math.max(weeklyIncome, 1);

        setBar(barNights, nightTotal / denom);
        setBar(barFood, foodCost / denom);
        setBar(barSubs, subsWeekly / denom);
        setBar(barLeft, left / denom);

        valNights.innerText = fmt(nightTotal);
        valFood.innerText = fmt(foodCost);
        valSubs.innerText = fmt(subsWeekly);
        valLeft.innerText = fmt(left);

        const biggest = maxKey({ nights: nightTotal, food: foodCost, subs: subsWeekly });
        insightText.innerText =
          biggest === "nights" ? "Your biggest cost is nights out. Reducing by 1 night can make a big difference." :
          biggest === "food" ? "Your biggest cost is food. A lower food tier could stabilise your week." :
          "Your biggest cost is subscriptions. Review the subscription manager and cut what you donâ€™t use.";
      }

      // Store last calculation snapshot
      lastCalculated = {
        createdAt: new Date().toISOString(),
        inputs: {
          loanPerYear: loanVal,
          wagePerMonth: wageVal,
          personalFunds: personalVal,
          uniIndex: Number(uni.value),
          uniName: uniObj.name,
          city: uniObj.city,
          foodPerWeek: foodCost,
          nightsOutPerWeek: nightsVal,
          subscriptionsQuickPerMonth: quickMonthly,
          premiumSubsUsedWeekly: subsWeekly
        },
        derived: {
          nightCostPerNight: nightCost,
          weeklyIncome: Number(weeklyIncome.toFixed(2)),
          weeklyNightTotal: Number(nightTotal.toFixed(2)),
          weeklyFood: Number(foodCost.toFixed(2)),
          weeklySubs: Number(subsWeekly.toFixed(2)),
          weeklySpent: Number(weeklySpent.toFixed(2)),
          weeklyBalance: Number(balance.toFixed(2))
        }
      };

      // refresh sub UI totals
      if (isPremium) renderSubItems();
    }

    function setBar(node, ratio) {
      node.style.width = (clamp01(ratio) * 100).toFixed(1) + "%";
    }

    function maxKey(obj) {
      let bestK = null, bestV = -Infinity;
      for (const k in obj) {
        if (obj[k] > bestV) { bestV = obj[k]; bestK = k; }
      }
      return bestK;
    }

    /* =========================
       Premium: Term forecast
       ========================= */
    termForecastBtn.addEventListener("click", () => {
      if (!isPremium) return alert("Premium required for term forecasting.");
      if (!lastCalculated) return alert("Calculate your budget first.");
      runTermForecast();
    });

    function runTermForecast() {
      const weeks = Number(termWeeks.value) || 0;
      if (weeks <= 0) {
        termResult.innerText = "Enter weeks left in term.";
        return;
      }

      const weeklyBalance = Number(lastCalculated.derived.weeklyBalance || 0);
      const weeklySpent = Number(lastCalculated.derived.weeklySpent || 0);
      const weeklyIncome = Number(lastCalculated.derived.weeklyIncome || 0);

      // Simple forecasting: savings after N weeks if positive, or deficit growth if negative
      const endValue = weeklyBalance * weeks;

      let msg = "";
      if (weeklyBalance >= 0) {
        msg = `âœ… At this pace, you could have about ${fmt(endValue)} left/saved after ${weeks} weeks.`;
      } else {
        msg = `âš ï¸ At this pace, you will be short by about ${fmt(Math.abs(endValue))} over ${weeks} weeks.`;
      }

      const startDate = termStart.value ? new Date(termStart.value) : null;
      let endDateText = "";
      if (startDate) {
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + (weeks * 7));
        endDateText = ` End date: ${endDate.toLocaleDateString()}.`;
      }

      termResult.innerText =
        `${msg}${endDateText}\nWeekly income: ${fmt(weeklyIncome)} | Weekly spend: ${fmt(weeklySpent)} | Weekly balance: ${fmt(weeklyBalance)}`;
    }

    exportTermCsvBtn.addEventListener("click", () => {
      if (!isPremium) return alert("Premium required for term export.");
      if (!lastCalculated) return alert("Calculate your budget first.");
      const weeks = Number(termWeeks.value) || 0;
      if (weeks <= 0) return alert("Enter weeks left in term first.");
      downloadTermCsv(weeks);
    });

    function downloadTermCsv(weeks) {
      const wIncome = Number(lastCalculated.derived.weeklyIncome || 0);
      const wSpend = Number(lastCalculated.derived.weeklySpent || 0);
      const wBal = Number(lastCalculated.derived.weeklyBalance || 0);

      const rows = [
        ["metric", "weekly", "term_total_weeks_" + weeks],
        ["income", wIncome.toFixed(2), (wIncome * weeks).toFixed(2)],
        ["spend", wSpend.toFixed(2), (wSpend * weeks).toFixed(2)],
        ["balance", wBal.toFixed(2), (wBal * weeks).toFixed(2)],
      ];

      const csv = rows.map(r => r.join(",")).join("\n");
      downloadTextFile(csv, `univio_term_summary_${weeks}w.csv`, "text/csv");
    }

    /* =========================
       Premium: What-if scenarios
       ========================= */
    runScenariosBtn.addEventListener("click", () => {
      if (!isPremium) return alert("Premium required for scenarios.");
      if (!lastCalculated) return alert("Calculate your budget first.");
      runScenarios();
    });

    function runScenarios() {
      const base = structuredCloneSafe(lastCalculated);

      const baseBalance = Number(base.derived.weeklyBalance || 0);
      const baseSpent = Number(base.derived.weeklySpent || 0);

      // reconstruct needed parts
      const nightsVal = Number(base.inputs.nightsOutPerWeek || 0);
      const nightCost = Number(base.derived.nightCostPerNight || 0);
      const foodCost = Number(base.inputs.foodPerWeek || 0);
      const subsWeekly = Number(base.derived.weeklySubs || 0);

      let nightsNew = nightsVal;
      let foodNew = foodCost;
      let subsNew = subsWeekly;
      let uberSavings = 0;

      if (scnOneLessNight.checked) nightsNew = Math.max(0, nightsVal - 1);
      if (scnCheaperFood.checked) {
        // cheaper tier logic
        foodNew = foodCost === 60 ? 40 : (foodCost === 40 ? 25 : 25);
      }
      if (scnCutSubs20.checked) subsNew = subsWeekly * 0.8;
      if (scnNoUbers.checked) {
        const uCost = Number(uberCost.value || 0);
        uberSavings = Math.max(0, uCost); // replace 1 uber/week with walking
      }

      const newNightTotal = nightsNew * nightCost;
      const newSpent = newNightTotal + foodNew + subsNew - uberSavings;
      const weeklyIncome = Number(base.derived.weeklyIncome || 0);
      const newBalance = weeklyIncome - newSpent;

      const delta = newBalance - baseBalance;

      scenarioResult.innerText =
        `Base weekly balance: ${fmt(baseBalance)}\n` +
        `Scenario weekly balance: ${fmt(newBalance)}\n` +
        `Change: ${delta >= 0 ? "+" : ""}${fmt(delta)}\n\n` +
        `Scenario details:\n` +
        `â€¢ Nights out: ${nightsVal} â†’ ${nightsNew} (night cost ${fmt(nightCost)})\n` +
        `â€¢ Food: ${fmt(foodCost)} â†’ ${fmt(foodNew)}\n` +
        `â€¢ Subscriptions: ${fmt(subsWeekly)} â†’ ${fmt(subsNew)}\n` +
        `â€¢ Uber savings: ${fmt(uberSavings)}`;
    }

    function structuredCloneSafe(obj) {
      try { return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj)); }
    }

    /* =========================
       Premium: Savings challenges
       ========================= */
    challengeBtn.addEventListener("click", () => {
      if (!isPremium) return alert("Premium required for challenges.");
      if (!lastCalculated) return alert("Calculate your budget first.");
      runChallenge();
    });

    function runChallenge() {
      const goal = Number(challengeGoal.value || 0);
      const weeks = Number(challengeWeeks.value || 0);
      const saved = Number(challengeSaved.value || 0);

      if (goal <= 0 || weeks <= 0) {
        challengeResult.innerText = "Enter a goal and deadline weeks.";
        return;
      }

      const remaining = Math.max(0, goal - saved);
      const weeklyTarget = remaining / weeks;

      const weeklyBalance = Number(lastCalculated.derived.weeklyBalance || 0);

      let msg = `Goal: ${fmt(goal)} | Already saved: ${fmt(saved)}\nRemaining: ${fmt(remaining)}\nWeekly target: ${fmt(weeklyTarget)}\n\n`;

      if (weeklyBalance >= weeklyTarget) {
        msg += `âœ… Your current weekly balance (${fmt(weeklyBalance)}) is enough to hit this goal.`;
      } else if (weeklyBalance > 0) {
        msg += `âš ï¸ Youâ€™re short by about ${fmt(weeklyTarget - weeklyBalance)} per week. Use scenarios to cut spending.`;
      } else {
        msg += `ðŸ”´ Youâ€™re currently overspending. Reduce weekly spend before starting the challenge.`;
      }

      challengeResult.innerText = msg;
    }

    /* =========================
       Export (FREE): latest calc CSV
       ========================= */
    exportCsvBtn.addEventListener("click", () => {
      if (!lastCalculated) return alert("Calculate your budget first.");
      downloadLatestCalcCsv();
    });

    function downloadLatestCalcCsv() {
      const d = lastCalculated;

      const rows = [
        ["field", "value"],
        ["timestamp", d.createdAt],
        ["university", d.inputs.uniName],
        ["city", d.inputs.city],
        ["weekly_income", d.derived.weeklyIncome.toFixed(2)],
        ["weekly_spent", d.derived.weeklySpent.toFixed(2)],
        ["weekly_balance", d.derived.weeklyBalance.toFixed(2)],
        ["weekly_nights_total", d.derived.weeklyNightTotal.toFixed(2)],
        ["weekly_food", d.derived.weeklyFood.toFixed(2)],
        ["weekly_subscriptions", d.derived.weeklySubs.toFixed(2)],
      ];

      const csv = rows.map(r => r.join(",")).join("\n");
      downloadTextFile(csv, "univio_latest_budget.csv", "text/csv");
    }

    function downloadTextFile(text, filename, mime) {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* =========================
       Save / Load budgets
       ========================= */
    saveBudgetBtn.addEventListener("click", saveBudget);
    loadBudgetBtn.addEventListener("click", () => loadLastBudget(true));

    async function saveBudget() {
      if (!currentUser) return alert("Please sign in to save your budget.");
      if (!lastCalculated) return alert("Calculate your budget first, then save it.");

      try {
        await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .add({
            ...lastCalculated,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        alert("Saved âœ…");
        if (isPremium) loadBudgetHistory();
      } catch (e) {
        console.error(e);
        alert("Saving failed: " + e.message);
      }
    }

    async function loadLastBudget(showUI) {
      if (!currentUser) return;

      if (showUI) loadStatus.innerText = "Loadingâ€¦";

      try {
        const snap = await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .orderBy("savedAt", "desc")
          .limit(1)
          .get();

        if (snap.empty) {
          if (showUI) loadStatus.innerText = "No saved budgets yet.";
          return;
        }

        const data = snap.docs[0].data();

        loan.value = data.inputs?.loanPerYear ?? 0;
        wage.value = data.inputs?.wagePerMonth ?? 0;
        personal.value = data.inputs?.personalFunds ?? 0;
        nights.value = data.inputs?.nightsOutPerWeek ?? 0;
        food.value = String(data.inputs?.foodPerWeek ?? 25);

        subscriptionsQuick.value = data.inputs?.subscriptionsQuickPerMonth ?? 0;

        if (typeof data.inputs?.uniIndex === "number") uni.value = data.inputs.uniIndex;

        calculateBudget();

        if (showUI) {
          loadStatus.innerText = "Loaded âœ…";
          showPage("calculator");
        }
      } catch (e) {
        console.error(e);
        if (showUI) loadStatus.innerText = "";
        if (showUI) alert("Load failed: " + e.message);
      }
    }

    /* =========================
       Budget history (Premium)
       ========================= */
    async function loadBudgetHistory() {
      if (!currentUser || !isPremium) return;

      historyList.innerHTML = `<div class="muted small">Loading historyâ€¦</div>`;

      try {
        const snap = await db.collection("users")
          .doc(currentUser.uid)
          .collection("budgets")
          .orderBy("savedAt", "desc")
          .limit(15)
          .get();

        if (snap.empty) {
          historyList.innerHTML = `<div class="muted small">No saved budgets yet.</div>`;
          return;
        }

        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          const ts = d.savedAt?.toDate ? d.savedAt.toDate() : null;
          const when = ts ? ts.toLocaleString() : (d.createdAt || "Saved");
          const balance = d.derived?.weeklyBalance ?? 0;
          const uniName = d.inputs?.uniName ?? "University";

          rows.push(`
            <div class="history-item">
              <div>
                <div class="history-title">${escapeHtml(uniName)}</div>
                <div class="muted small">${escapeHtml(when)}</div>
              </div>
              <div class="history-right">
                <div class="history-balance">${fmt(balance)}</div>
                <button class="secondary history-btn" data-budget-id="${doc.id}">Load</button>
              </div>
            </div>
          `);
        });

        historyList.innerHTML = rows.join("");
        historyList.querySelectorAll("button[data-budget-id]").forEach(btn => {
          btn.addEventListener("click", () => loadBudgetById(btn.getAttribute("data-budget-id")));
        });

      } catch (e) {
        console.error(e);
        historyList.innerHTML = `<div class="muted small">Failed to load history.</div>`;
      }
    }

    async function loadBudgetById(docId) {
      if (!currentUser || !isPremium) return;

      try {
        const docRef = db.collection("users").doc(currentUser.uid).collection("budgets").doc(docId);
        const snap = await docRef.get();
        if (!snap.exists) return;

        const data = snap.data();

        loan.value = data.inputs?.loanPerYear ?? 0;
        wage.value = data.inputs?.wagePerMonth ?? 0;
        personal.value = data.inputs?.personalFunds ?? 0;
        nights.value = data.inputs?.nightsOutPerWeek ?? 0;
        food.value = String(data.inputs?.foodPerWeek ?? 25);
        subscriptionsQuick.value = data.inputs?.subscriptionsQuickPerMonth ?? 0;

        if (typeof data.inputs?.uniIndex === "number") uni.value = data.inputs.uniIndex;

        calculateBudget();
        showPage("calculator");
      } catch (e) {
        console.error(e);
        alert("Load failed: " + e.message);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    /* =========================
       Navigation
       ========================= */
    const pages = ["home", "calculator", "account"];
    document.querySelectorAll(".nav-link").forEach(btn => {
      btn.addEventListener("click", () => showPage(btn.dataset.page));
    });

    function showPage(p) {
      pages.forEach(x => el("page-" + x).classList.toggle("active", x === p));
      document.querySelectorAll(".nav-link").forEach(b => b.classList.toggle("active", b.dataset.page === p));
      window.scrollTo(0, 0);
    }

    el("go-calc").addEventListener("click", () => showPage("calculator"));
    el("go-account").addEventListener("click", () => showPage("account"));

    /* =========================
       Auto: keep subs weekly total updated visually
       ========================= */
    // This is safe even if not premium.
    setInterval(() => {
      if (isPremium) renderSubItems();
    }, 3000);
  </script>
</body>
</html>



